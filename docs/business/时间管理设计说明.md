# 时间管理设计说明

## 一、设计目标

本项目时间系统用于：

- 复习记录时间
- 题目创建时间
- 逻辑日（凌晨3点切分）
- 复习间隔计算
- 按逻辑日统计与查询

设计原则：

- 数据库存储稳定
- 业务逻辑统一
- 时区安全
- 避免 chrono 扩散到业务层

------------------------------------------------------------------------

## 二、时间分层模型

| 层级 | 使用类型 | 说明 |
| - | - | - |
| DB | i64 | Unix Timestamp（秒） |
| Repo | Timestamp | 业务时间类型 |
| Logic | LogicalDay | 逻辑日编号 |
| UI | String | 展示格式 |

------------------------------------------------------------------------

## 三、核心时间类型

### Timestamp

``` rust
pub struct Timestamp(pub i64);
```

用途：

- Repo层唯一时间类型
- 封装Unix时间戳

禁止：

- Repo层使用裸i64表示时间

------------------------------------------------------------------------

### LogicalDay

``` rust
pub struct LogicalDay(pub i32);
```

用途：

- 表示逻辑日编号
- 非日期
- 非时间戳

逻辑日定义：

凌晨3点作为一天分界。

------------------------------------------------------------------------

## 四、逻辑日算法

计算步骤：

1. 将timestamp转换到用户时区
2. 向前移动3小时
3. 计算日期
4. 转换为num_days_from_ce编号

逻辑日仅用于：

- 复习统计
- 复习查询
- days_since计算

禁止写入数据库。

------------------------------------------------------------------------

## 五、时间工具模块结构

```text
    util/time/
    ├── timestamp.rs
    ├── logical_day.rs
    ├── 
    ├── days_since.rs
    └── now.rs
```

------------------------------------------------------------------------

## 六、时间操作规范

当前时间获取：

```rust
    util::time::now::now_ts()
```

禁止在Repo/DB中直接调用chrono。

Timestamp转LogicalDay：

```rust
    from_timestamp(ts)
```

逻辑日范围查询：

```rust
    range_of_day(day)
```

复习间隔计算：

``` rust
    days_since(old, now)
```

------------------------------------------------------------------------

## 七、数据库时间存储规范

统一使用：

INTEGER unix timestamp（秒）

字段命名规范：

- created_at
- reviewed_at
- updated_at
- deleted_at

------------------------------------------------------------------------

## 八、chrono使用规则

只允许存在于：

util/time模块内部。

禁止在：

- Repo
- DB
- UI

中直接使用chrono。

------------------------------------------------------------------------

## 九、设计总结

- DB只存i64
- Repo使用Timestamp
- LogicalDay仅用于计算
- chrono仅在util/time
- UI不处理时间逻辑
