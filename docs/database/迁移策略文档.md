# 数据库迁移策略

本项目采用**版本化迁移**机制，确保数据库结构随代码演进安全、可控地升级。以下为迁移策略说明：

## 1. 迁移机制概述

- 数据库建表语句都内涵在迁移（Migration）中。
- 每次数据库结构变更（如新增表、字段、索引等）都需新增一条迁移。
- 每条迁移包含唯一递增的 `version`，对应的 `name` 及 `sql` 脚本。
- 启动时自动检测当前数据库版本，依次应用未应用的迁移，保证结构最新。
- 所有迁移均在事务中执行，失败自动回滚。

## 2. 迁移表结构

- `schema_version` 表用于记录当前数据库结构版本。
- 结构如下：

  | 字段名 | 类型 | 说明 |
  | - | - | - |
  | version | INTEGER | 当前 schema 版本 |

## 3. 迁移流程

1. 启动时，确保 `schema_version` 表存在。
2. 读取当前数据库版本号。
3. 按 `version` 升序遍历所有迁移，依次应用高于当前版本的迁移。
4. 每条迁移在事务中执行，成功后更新 `schema_version`。

## 4. 迁移脚本示例

```rust
const MIGRATIONS: &[Migration] = &[Migration {
    version: 1,
    name: "init_schema",
    sql: r#"
        CREATE TABLE IF NOT EXISTS schema_version (
            version INTEGER NOT NULL
        );
        INSERT INTO schema_version (version)
        SELECT 0
        WHERE NOT EXISTS (SELECT 1 FROM schema_version);
        CREATE TABLE question (...);
        CREATE TABLE review (...);
        CREATE TABLE asset (...);
        CREATE TABLE meta (...);
    "#,
}];
```

## 5. 迁移注意事项

- **每次结构变更必须新增 version，禁止直接修改旧迁移脚本。**
- 迁移 SQL 必须可重复执行不报错。
- 迁移应尽量向前兼容，避免破坏已有数据。
- 生产环境升级前建议备份数据库。

## 6. 常见场景举例

- 新增字段：

  ```sql
  ALTER TABLE meta ADD COLUMN created_at INTEGER NOT NULL DEFAULT 0;
  ```

- 新增表：

  ```sql
  CREATE TABLE IF NOT EXISTS new_table (...);
  ```

- 字段重命名/类型变更：建议新建字段+数据迁移+删除旧字段。

## 7. 版本管理建议

- 迁移脚本与代码一同版本管理，禁止手动修改数据库结构。
- 每次迁移需详细注释变更内容。

---

如需手动修复历史数据或结构，请严格评估风险并做好备份。
